---
title: 事件循环
date: 2019-06-22 11:55:39
tags: js
---

为什么JavaScript是单线程的？
单线程意思就是说同一个时间只能做一件事，但这并不以为这js是一种效率非常低的语言，其实javascript的单线程特点是跟他的用途有关的。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。假如不是单线程的话，在一个线程当我们在给某个DOM节点增加内容的时候，另一个线程正在删除这个DOM节点的内容，那还得了。所以javascript只能是单线程。
虽然javascript是单线程，但是javascript中有同步和异步的概念，解决了js阻塞的问题。

<!-- more -->

### 同步和异步

javascript是单线程。单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。
于是js所有任务分为两种：同步任务，异步任务
- 同步任务是调用立即得到结果的任务，同步任务在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务
- 异步任务是调用无法立即得到结果，异步任务不进入主线程、而进入任务队列的任务，只有任务队列通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。

### js运行机制如下

![1](/image/事件循环/1.jpg)

偷的图，见谅

1.js主线程是按代码顺序执行代码的，遇到异步任务，主线程交给浏览器webapis调用异步函数发起异步请求，主线程继续执行后面的代码。
>WebAPIs：浏览器为异步任务单独开辟的线程（服务JavaScript的，处理JavaScript的异步）
>虚线那一块（看图）：堆（heap）和栈（stack）共同组成了js主线程（这个就是我们JavaScript的线程）
>callback queue（最下面的那个长方形）：任务队列，里面放着各种事件，比如我们点击所触发的事件，浏览器会帮我们以任务的形式，把他放入任务队列中
>event loop（那个转圈圈）：任务循环，又叫事件循环。

2.异步任务开始执行异步操作，执行完成后到消息队列中排队。
3.程序按照代码顺序执行完毕后，查询消息队列中是否有等待的消息。如果有，则按照次序从消息队列中把消息放到执行栈中执行。
4.执行完毕后，再从消息队列中获取消息，再执行，不断重复。

### 宏任务与微任务

不同类型的任务会进入对应的Event Queue，比如setTimeout和setInterval会进入相同的Event Queue。
macro-task(宏任务)：包括整体代码script，setTimeout，setInterval
micro-task(微任务)：Promise，process.nextTick
事件循环的顺序，决定js代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。
任务队列中有两种任务，微任务和宏任务，同一任务队列中按照次序，不同队列按照优先级，先执行微任务再执行宏任务

最后让我们一起做一道题吧

    console.log(1)
    async function a1(){
        console.log(2)
        await console.log(3)
        console.log(4)
    }
    setTimeout(function(){
        console.log(5)
    },0)
    a1()
    new Promise(function (resolve){
        console.log(6)
        resolve()
    }).then(function () {
        console.log(7)
    })
    console.log(8)

正确答案：12368475
